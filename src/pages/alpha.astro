---
import Layout from '../layouts/Layout.astro';

const discoveryOptions = [
  { value: 'twitter', label: 'Twitter/X' },
  { value: 'hackernews', label: 'Hacker News' },
  { value: 'reddit', label: 'Reddit' },
  { value: 'referral', label: 'Friend referral' },
  { value: 'google', label: 'Google search' },
  { value: 'ai-communities', label: 'AI coding communities' },
  { value: 'other', label: 'Other' },
];

const PUBLIC_TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
---

<Layout title="Request Alpha Access - Neural Commander">
  <section class="pt-32 pb-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
      <!-- Hero -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-nc-green/10 border border-nc-green/20 mb-6">
          <span class="w-2 h-2 bg-nc-green rounded-full animate-pulse"></span>
          <span class="text-nc-green text-sm font-medium">v0.98.1 Alpha Available</span>
        </div>
        <h1 class="text-4xl sm:text-5xl font-bold text-white mb-6">
          Request <span class="gradient-text">Alpha Access</span>
        </h1>
        <p class="text-xl text-nc-light/80 max-w-xl mx-auto">
          Neural Commander is in private alpha. Submit your details below to request access to the GitHub repository.
        </p>
      </div>

      <!-- Form -->
      <div class="bg-nc-dark rounded-2xl p-8 border border-white/10">
        <form class="space-y-6" id="alpha-form">
          <!-- Name -->
          <div>
            <label for="name" class="block text-white text-sm font-medium mb-2">
              Full Name <span class="text-nc-error">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              placeholder="Your name"
              required
              class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-nc-light/40 focus:outline-none focus:border-nc-blue"
            />
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-white text-sm font-medium mb-2">
              Email Address <span class="text-nc-error">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="you@example.com"
              required
              class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-nc-light/40 focus:outline-none focus:border-nc-blue"
            />
          </div>

          <!-- GitHub Username -->
          <div>
            <label for="github" class="block text-white text-sm font-medium mb-2">
              GitHub Username <span class="text-nc-error">*</span>
            </label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-nc-light/40">@</span>
              <input
                type="text"
                id="github"
                name="github"
                placeholder="yourusername"
                required
                pattern="^[a-zA-Z0-9](?:[a-zA-Z0-9]|-(?=[a-zA-Z0-9])){0,38}$"
                class="w-full pl-8 pr-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-nc-light/40 focus:outline-none focus:border-nc-blue"
              />
            </div>
            <p class="mt-1 text-nc-light/40 text-xs">
              We'll send you a GitHub collaborator invite
            </p>
          </div>

          <!-- Discovery -->
          <div>
            <label for="discovery" class="block text-white text-sm font-medium mb-2">
              How did you find Neural Commander? <span class="text-nc-error">*</span>
            </label>
            <select
              id="discovery"
              name="discovery"
              required
              class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white focus:outline-none focus:border-nc-blue appearance-none"
              style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 20 20%22 fill=%22%239ca3af%22><path fill-rule=%22evenodd%22 d=%22M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z%22 clip-rule=%22evenodd%22/></svg>'); background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.25rem;"
            >
              <option value="" disabled selected class="text-nc-light/40">Select an option...</option>
              {discoveryOptions.map((opt) => (
                <option value={opt.value}>{opt.label}</option>
              ))}
            </select>
          </div>

          <!-- Motivation -->
          <div>
            <label for="motivation" class="block text-white text-sm font-medium mb-2">
              Why do you want to test Neural Commander? <span class="text-nc-error">*</span>
            </label>
            <textarea
              id="motivation"
              name="motivation"
              rows="4"
              placeholder="Tell us about your use case, what problems you're facing with AI coding tools, or why NC interests you..."
              required
              minlength="20"
              class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-nc-light/40 focus:outline-none focus:border-nc-blue resize-none"
            ></textarea>
            <p class="mt-1 text-nc-light/40 text-xs">
              Minimum 20 characters
            </p>
          </div>

          <!-- Turnstile Widget -->
          {PUBLIC_TURNSTILE_SITE_KEY && (
            <div class="flex justify-center">
              <div
                class="cf-turnstile"
                data-sitekey={PUBLIC_TURNSTILE_SITE_KEY}
                data-theme="dark"
              ></div>
            </div>
          )}

          <!-- Submit -->
          <button
            type="submit"
            class="w-full px-6 py-4 rounded-xl bg-nc-green hover:bg-nc-green/90 text-white font-semibold text-lg transition-all hover:scale-[1.02]"
          >
            Request Alpha Access
          </button>

          <p class="text-nc-light/40 text-xs text-center">
            We'll review your request and send a GitHub invite within 24 hours.
          </p>
        </form>
      </div>

      <!-- What Happens Next -->
      <div class="mt-12">
        <h2 class="text-xl font-bold text-white mb-6 text-center">What Happens Next?</h2>
        <div class="grid gap-4">
          <div class="bg-nc-dark rounded-xl p-6 border border-white/10 flex gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-nc-blue/20 flex items-center justify-center text-nc-blue font-bold">1</div>
            <div>
              <h3 class="text-white font-semibold mb-1">We review your request</h3>
              <p class="text-nc-light/70 text-sm">Bradley personally reviews each alpha request.</p>
            </div>
          </div>
          <div class="bg-nc-dark rounded-xl p-6 border border-white/10 flex gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-nc-blue/20 flex items-center justify-center text-nc-blue font-bold">2</div>
            <div>
              <h3 class="text-white font-semibold mb-1">You receive a GitHub invite</h3>
              <p class="text-nc-light/70 text-sm">Check your email and GitHub notifications for the collaborator invite.</p>
            </div>
          </div>
          <div class="bg-nc-dark rounded-xl p-6 border border-white/10 flex gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-nc-green/20 flex items-center justify-center text-nc-green font-bold">3</div>
            <div>
              <h3 class="text-white font-semibold mb-1">Download and start testing</h3>
              <p class="text-nc-light/70 text-sm">Access the releases page, download the binary, and start using NC!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<!-- Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  const form = document.getElementById('alpha-form') as HTMLFormElement;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const originalButtonText = submitButton?.textContent || 'Request Alpha Access';

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = (document.getElementById('name') as HTMLInputElement)?.value;
    const email = (document.getElementById('email') as HTMLInputElement)?.value;
    const github = (document.getElementById('github') as HTMLInputElement)?.value;
    const discovery = (document.getElementById('discovery') as HTMLSelectElement)?.value;
    const motivation = (document.getElementById('motivation') as HTMLTextAreaElement)?.value;

    // Get Turnstile token
    const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]') as HTMLInputElement;
    const turnstileToken = turnstileResponse?.value || '';

    // Validation
    if (!name || !email || !github || !discovery || !motivation) {
      alert('Please fill in all required fields');
      return;
    }

    if (motivation.length < 20) {
      alert('Please provide a more detailed motivation (at least 20 characters)');
      return;
    }

    // Update button state
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting...';

    try {
      const response = await fetch('/api/alpha-signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          email,
          github,
          discovery,
          motivation,
          turnstileToken
        }),
      });

      const data = await response.json();

      if (response.ok) {
        // Success - show confirmation
        form.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4">ðŸŽ‰</div>
            <h3 class="text-2xl font-bold text-white mb-2">Request Submitted!</h3>
            <p class="text-nc-light/80 mb-4">We'll review your request and send a GitHub invite within 24 hours.</p>
            <p class="text-nc-light/60 text-sm">Check your email at <span class="text-white">${email}</span></p>
          </div>
        `;
      } else {
        throw new Error(data.error || 'Something went wrong');
      }
    } catch (error) {
      alert(error instanceof Error ? error.message : 'Failed to submit request. Please try again.');
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;

      // Reset Turnstile
      if (typeof (window as any).turnstile !== 'undefined') {
        (window as any).turnstile.reset();
      }
    }
  });
</script>
